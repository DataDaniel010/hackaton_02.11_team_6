---
title: "Hackaton"
author: "Danil Tukanov"
date: "2025-11-02"
output: html_document
---

```{r first chunk}
library(tidyverse)
library(gtsummary)
library(forcats)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(patchwork)
library(ggrepel)
library(ggthemes)

library(flextable)
library(epitools)

set_flextable_defaults(table.layout = "autofit")
```
#Чтение данных

```{r}
insurance_data <- read_csv("data/HealthInsurance.csv")

insurance_data %>% 
  summary()

```

#Описание данных
Сформировать таблицы с базовыми описательными статистиками.

## Черновик таблицы 1

```{r}
insurance_t1_data <- insurance_data %>%
  mutate(insurance = fct_recode(insurance, "Нет страховки" = "no", "Есть страховка" = "yes")) %>% 
    mutate(
    education = fct_relevel(
      education,
      "none", "ged", "highschool", "bachelor", "master", "phd", "other"
    )
  ) %>% 
  mutate(
    education = fct_recode(
      education,
      "Нет диплома" = "none",
      "Аттестат (GED)" = "ged",
      "Средняя школа" = "highschool",
      "Бакалавр" = "bachelor",
      "Магистр" = "master",
      "Доктор наук (PhD)" = "phd",
      "Другое" = "other"
    )
  ) %>% 
  mutate(
    region = fct_recode(region,
      "Средний Запад" = "midwest",
      "Северо-восток" = "northeast",
      "Юг" = "south",
      "Запад" = "west"
    ),
    ethnicity = fct_recode(ethnicity,
      "Афроамериканцы" = "afam",
      "Европеоидные" = "cauc",
      "Другие" = "other"
    ),
    gender = fct_recode(gender,
      "Мужской" = "male",
      "Женский" = "female"
    )
  )


table_1 <- insurance_t1_data %>% 
  select(age,
         gender,
        ethnicity,
        region,
         married,
         family,
        health,
         limit,
         insurance,
        education,
         selfemp) %>%
  tbl_summary(
    by = insurance, # группировка
    label = list(
      age ~ "Возраст,лет",
      gender ~ "Пол",
      ethnicity ~ "Этническая группа",
      region ~ "Регион",
      married ~ "Состоит в браке",
      family ~ "Количество членов семьи",
      health ~ "Здоров по самоотчету",
      limit ~ "Есть ограничения",
      education ~ "Уровень образования",
      selfemp ~ "Самозанятый"
    ),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing_text = "Нет данных"
  ) %>%
  add_overall() %>%  
  bold_labels() %>%   
   modify_header(label = "Характеристика") %>%
   modify_header(
    label = "**Характеристика**",  # Жирный для характеристик
    stat_0 = "**Всего**<br>N = {N}",  # Жирный + N=
    stat_1 = "**Нет страховки**<br>N = {n}",  # Жирный + N=
    stat_2 = "**Есть страховка**<br>N = {n}"   # Жирный + N=
  ) %>%
 modify_spanning_header(
    c("stat_0", "stat_1", "stat_2") ~ "Описательные характеристики респондентов"
  )

table_1
```


#Визуализация данных
Визуализировать распределения значений признаков средствами ggplot2 и сопутствующих пакетов.
Подобрать и реализовать средства для визуальной оценки взаимосвязи между наличием МС и собранными признаками пациентов.

```{r}

plot_categorical <- function(df) {
  categorical_vars <- names(df)[sapply(df, function(x) is.factor(x) | is.character(x))]
  
  plots <- list()
  for(var in categorical_vars) {
    freq_data <- as.data.frame(table(df[[var]]))
    names(freq_data) <- c("Category", "Count")
    freq_data$Percentage <- round(freq_data$Count / sum(freq_data$Count) * 100, 1)
    freq_data$Label <- paste0(freq_data$Count, "\n", freq_data$Percentage, "%")
    
    freq_data <- freq_data[order(-freq_data$Count), ]
    freq_data$Category <- factor(freq_data$Category, levels = freq_data$Category)
    
    p <- ggplot(freq_data, aes(x = Category, y = Count, fill = Category)) +
      geom_bar(stat = "identity", alpha = 0.8) +
      
      geom_text_repel(
        aes(label = Label),
        color = "black",
        size = 3.5,
        fontface = "bold",
        direction = "y",
        nudge_y = max(freq_data$Count) * 0.05, 
        segment.color = "gray50",
        segment.size = 0.3,
        min.segment.length = 0.1,
        box.padding = 0.2,
        point.padding = 0.2,
        lineheight = 0.8
      )  +
      
      scale_fill_brewer(palette = "Set2") +
      labs(title = paste("Переменная:", var),
           subtitle = paste("Категорий:", nrow(freq_data)),
           x = "", y = "Количество") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "none",
            plot.title = element_text(face = "bold", size = 14)) +
      scale_y_continuous(expand = expansion(mult = c(0, 0.15))) 
    
    plots[[var]] <- p
  }
  
  grid.arrange(grobs = plots, ncol = 3)
}

plot_numeric<- function(df) {
  numeric_vars <- names(df)
  
  plots <- list()
  for(var in numeric_vars) {
    mean_val <- mean(df[[var]], na.rm = TRUE)
    median_val <- median(df[[var]], na.rm = TRUE)
    sd_val <- sd(df[[var]], na.rm = TRUE)
    
    p <- ggplot(df, aes(x = .data[[var]])) +
      geom_histogram(aes(y = ..density..),
                     bins = 25,
                     fill = "lightblue",
                     alpha = 0.7,
                     color = "white",
                     linewidth = 0.3) +

      geom_density(color = "darkgreen",
                   linewidth = 1.2,
                   alpha = 0.8) +
      geom_vline(xintercept = median_val,
                 color = "red",
                 linewidth = 1.2,
                 linetype = "dashed") +
      
      annotate("label",
               x = Inf, y = Inf,
               label = paste0("Среднее: ", round(mean_val, 2), "\n",
                             "Медиана: ", round(median_val, 2), "\n", 
                             "SD: ", round(sd_val, 2)),
               hjust = 1.1, vjust = 1.5,
               size = 3.5,
               color = "black",
               fontface = "bold") +
      labs(title = paste("Распределение:", var),
           x = var,
           y = "Плотность") +
      theme_minimal() +
      theme(
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
        plot.background = element_rect(fill = "white", color = NA)
      )
    
    plots[[var]] <- p
  }
  
  wrap_plots(plots, ncol = 2) +
    plot_annotation(
      title = "Распределение числовых переменных",
      theme = theme(plot.title = element_text(size = 16, face = "bold", hjust = 0.5))
    )
}


insurance_data[sapply(insurance_data, is.numeric)] %>% 
  select(-rownames) -> numeric_columns


```


```{r fig.width=8, fig.height=8}
plot_numeric(numeric_columns)
```

```{r fig.width=12, fig.height=10}
plot_categorical(insurance_data)
```

#Анализ данных
Выбрать и реализовать методы однофакторного анализа для количественной оценки взаимосвязи между наличием МС и собранными признаками пациентов (помните, что взаимосвязь - это не только p-значения, но и доверительные интервалы!).

Исследование кросс-секционное. Для оценки независимости групп с категориальными признаками будет использован тест хи-квадрат, для оценки силы ассоциации среди категориальных переменных будет использован RR.

Для оценки разницы между количественными переменными будет использован t-test.

Уровень значимости во всех случаях p<0.05

```{r}
insurance_data %>% 
  mutate(insurance = ifelse(insurance == "no", "Нет страховки", "Есть страховка")) -> insurance_data
```


##Пол и страховка
```{r}
insurance_data %>% 
  select(c("gender", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> gend_table

gend_table <- cbind("Пол" = rownames(gend_table), gend_table)
rownames(gend_table) <- NULL


ft_gend <- flextable(gend_table)
ft_gend <- autofit(ft_gend)
ft_gend <- theme_vanilla(ft_gend)
ft_gend <- add_header_lines(ft_gend, values = "Гендер и наличие страховки")
ft_gend <- align(ft_gend, i = 1, part = "header", align = "center")
ft_gend
```


```{r}
insurance_data %>% 
  select(c("gender", "insurance")) %>% 
  table %>% 
  chisq.test() -> gend

cat("Проверка гипотезы о независимости пола и наличия страховки\n")
gend$method
cat("P-value:")
gend$p.value
cat("Отклоняем нулевую гипотезу о независимости пола и наличия страховки")

```
Сила ассоциации
```{r}
insurance_data %>% 
  select(c("gender", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "both") -> rr_gender

rr_gender$measure
cat("RR показывает, что у женщин есть страховка в 1.067 раз чаще CI (1.045 - 1.089)")

```


##Семейное положение и страховка

```{r}
insurance_data %>% 
  mutate(married = ifelse(married == "no", "Нет брака", "В браке")) %>% 
  select(c("married", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> married_table

married_table <- cbind("Семейное положение" = rownames(married_table), married_table)
rownames(married_table) <- NULL


ft_married <- flextable(married_table)
ft_married <- autofit(ft_married)
ft_married <- theme_vanilla(ft_married)
ft_married <- add_header_lines(ft_married, values = "Семейное положение и наличие страховки")
ft_married <- align(ft_married, i = 1, part = "header", align = "center")
ft_married

```

```{r}
insurance_data %>% 
  select(c("married", "insurance")) %>% 
  table %>% 
  chisq.test() -> married

cat("Проверка гипотезы о независимости семейного положения и наличия страховки\n")
married$method
cat("P-value:")
married$p.value
cat("Отклоняем нулевую гипотезу о независимости семейного положения и наличия страховки")
```
Сила ассоциации
```{r}
insurance_data %>% 
  select(c("married", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "columns") -> rr_married

rr_married$measure
cat("RR показывает, что у людей в браке есть страховка в 1.2 раза чаще, CI(1.179 - 1.237)")

```
## Самозанятость и страховка

```{r}
insurance_data %>% 
  mutate(selfemp = ifelse(selfemp == "no", "Не самозанятый", "Самозанятый")) %>% 
  select(c("selfemp", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> selfemp_table

selfemp_table <- cbind("Самозанятость" = rownames(selfemp_table), selfemp_table)
rownames(selfemp_table) <- NULL


ft_selfemp <- flextable(selfemp_table)
ft_selfemp <- autofit(ft_selfemp)
ft_selfemp <- theme_vanilla(ft_selfemp)
ft_selfemp <- add_header_lines(ft_selfemp, values = "Самозанятость и наличие страховки")
ft_selfemp <- align(ft_selfemp, i = 1, part = "header", align = "center")
ft_selfemp
```

```{r}
insurance_data %>% 
  select(c("selfemp", "insurance")) %>% 
  table %>% 
  chisq.test() -> selfemp

cat("Проверка гипотезы о независимости статуса самозанятого и наличия страховки\n")
selfemp$method
cat("P-value:")
selfemp$p.value
cat("Отклоняем нулевую гипотезу о независимости статуса самозанятого и наличия страховки")

```
Сила ассоциации
```{r}
insurance_data %>% 
  select(c("selfemp", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "columns") -> rr_selfemp

rr_selfemp$measure
cat("RR показывает, что у самозанятых есть страховка в 0.84 раз реже, CI(0.809 - 0.879)\n")


insurance_data %>% 
  select(c("selfemp", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "both") -> rr_selfemp1

rr_selfemp1$measure
cat("RR показывает, что у не самозанятых есть страховка в 1.19 раз чаще, CI(1.137 - 1.236)")
```
##Здоровье и страховка

```{r}
insurance_data %>% 
  mutate(health = ifelse(health == "no", "Болен", "Здоров")) %>% 
  select(c("health", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> health_table

health_table <- cbind("Состояние здоровья" = rownames(health_table), health_table)
rownames(health_table) <- NULL


ft_health <- flextable(health_table)
ft_health <- autofit(ft_health)
ft_health <- theme_vanilla(ft_health)
ft_health <- add_header_lines(ft_health, values = "Состояние здоровья и наличие страховки")
ft_health <- align(ft_health, i = 1, part = "header", align = "center")
ft_health

```

```{r}
insurance_data %>% 
  select(c("health", "insurance")) %>% 
  table %>% 
  chisq.test() -> health

cat("Проверка гипотезы о независимости состояния здоровья и наличия страховки\n")
health$method
cat("P-value:")
health$p.value
cat("Отклоняем нулевую гипотезу о независимости состояния здоровья и наличия страховки")

```
Сила ассоциации
```{r}
insurance_data %>% 
  select(c("health", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "columns") -> rr_health

rr_selfemp$measure
cat("RR показывает, что у здоровых есть страховка в 1.11 раза чаще, CI(1.055 - 1.164)")
```
##Регион и страховка

```{r}
insurance_data %>% 
  select(c("region", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> region_table

region_table <- cbind("Регион проживания" = rownames(region_table), region_table)
rownames(region_table) <- NULL


ft_region <- flextable(region_table)
ft_region <- autofit(ft_region)
ft_region <- theme_vanilla(ft_region)
ft_region <- add_header_lines(ft_region, values = "Регион проживания и наличие страховки")
ft_region <- align(ft_region, i = 1, part = "header", align = "center")
ft_region


```


```{r}
insurance_data %>% 
  select(c("region", "insurance")) %>% 
  table %>% 
  chisq.test() -> region

cat("Проверка гипотезы о независимости региона проживания и наличия страховки\n")
region$method
cat("P-value:")
region$p.value
cat("Отклоняем нулевую гипотезу о независимости региона проживания и наличия страховки")

```
Сила ассоциации

```{r}
insurance_data %>% 
  select(c("region", "insurance")) %>% 
  table -> region_4x2

riskratio(region_4x2[c("midwest", "northeast"), ], rev = "columns") -> rr_mw_ne
rr_mw_ne$measure
cat("RR показывает, что у проживающих на северовостоке есть страховка в 0.974  раза реже, чем у тех, кто проживает на midwest CI(0.947 - 1.002) 
    CI накрывает 1!!!")
```


```{r}
riskratio(region_4x2[c("south", "west"), ], rev = "columns") -> rr_s_w
rr_s_w$measure
cat("RR показывает, что у проживающих на западе есть страховка в 0.964 раза реже, чем у тех, кто проживает на юге CI(0.935 - 0.995)")
```

```{r}
riskratio(region_4x2[c("midwest", "south"), ], rev = "columns") -> rr_mw_s
rr_mw_s$measure
cat("RR показывает, что у проживающих на юге есть страховка в 0.915 раза реже, чем у тех, кто проживает на midwest CI(0.892 - 0.939)")
```
```{r}
riskratio(region_4x2[c("midwest", "west"), ], rev = "columns") -> rr_mw_w
rr_mw_w$measure
cat("RR показывает, что у проживающих на западе есть страховка в 0.883 раза реже, чем у тех, кто проживает на midwest CI(0.856 - 0.910)")
```

```{r}
riskratio(region_4x2[c("northeast", "south"), ], rev = "columns") -> rr_ne_s
rr_ne_s$measure
cat("RR показывает, что у проживающих на юге есть страховка в 0.939 раза реже, чем у тех, кто проживает на северовостоке CI(0.913 - 0.966)")

```

```{r}
riskratio(region_4x2[c("northeast", "west"), ], rev = "columns") -> rr_ne_w
rr_ne_w$measure
cat("RR показывает, что у проживающих на западе есть страховка в 0.906 раза реже, чем у тех, кто проживает на северовостоке CI(0.877 - 0.936)")
```

##Образование и страховка
Образование можно представить как категориальную порядковую переменную, ведь PhD явно лучше bachelor. Можно попробовать применить тест Манна-Уитни
Нулевая гипотеза: распределение уровней образования одинаково для обеих групп (со страховкой и без)
Альтернативная гипотеза: распределение уровней образования различно для групп
```{r}
insurance_data %>% 
 # mutate(education_binary = ifelse(education == c("bachelor", "highschool", "ged", "phd" )))
  mutate(education = factor(education, levels = c("other", "none", "ged", "highschool", "bachelor", "master", "phd"), labels = c(0, 1, 2, 2, 3, 4, 5))) %>% 
  mutate(education = as.numeric(education)) -> insurance_data_mw

insurance_data_mw %>% 
  mutate(insurance = factor(insurance)) -> insurance_data_mw

mw <- wilcox.test(education ~ insurance, data = insurance_data_mw)

cat("P-значение:")
mw$p.value
cat("Отвергаем нулевую гипотезу об одинаковом распределении уровней образования для обеих групп")

```
Другой вариант, категоризируем уровни образования на три категории и далее находим хи-квадрат и RR: 
```{r}
insurance_data %>% 
  mutate(education = factor(education, levels = c("other", "none", "ged", "highschool", "bachelor", "master", "phd"), labels = c("Отсутствие или другое", "Отсутствие или другое", "Школьный уровень", "Школьный уровень", "Высшее образование", "Высшее образование", "Высшее образование"))) -> insurance_data_3x2

```


```{r}
insurance_data_3x2 %>% 
  select(c("education", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> education_table

education_table <- cbind("Уровень образования" = rownames(education_table), education_table)
rownames(education_table) <- NULL


ft_education <- flextable(education_table)
ft_education <- autofit(ft_education)
ft_education <- theme_vanilla(ft_education)
ft_education <- add_header_lines(ft_education, values = "Уровень образования и наличие страховки")
ft_education <- align(ft_education, i = 1, part = "header", align = "center")
ft_education
```

```{r}
insurance_data_3x2 %>% 
  select(c("education", "insurance")) %>% 
  table %>% 
  chisq.test() -> education

cat("Проверка гипотезы о независимости уровня образования и наличия страховки\n")
education$method
cat("P-value:")
education$p.value
cat("Отклоняем нулевую гипотезу о независимости уровня образования и наличия страховки")
```

Сила ассоциаций
```{r}
insurance_data_3x2 %>% 
  select(c("education", "insurance")) %>% 
  table -> education_3x2

riskratio(education_3x2[c("Отсутствие или другое", "Школьный уровень"), ], rev = "columns") -> rr_ot_sch
rr_ot_sch$measure
cat("RR показывает, что у людей со школьным уровнем образования в 1.2 раза чаще встречается страховка, чем у людей без образования или другое CI(1.17, 1.26)")


```


```{r}
riskratio(education_3x2[c("Отсутствие или другое", "Высшее образование"), ], rev = "columns") -> rr_ot_high
rr_ot_high$measure
cat("RR показывает, что у людей с высшим образования в 1.37 раза чаще встречается страховка, чем у людей без образования или другое CI(1.32, 1.42)")
```
```{r}
riskratio(education_3x2[c("Школьный уровень", "Высшее образование"), ], rev = "columns") -> rr_sch_high
rr_sch_high$measure
cat("RR показывает, что у людей с высшим образования в 1.12 раза чаще встречается страховка, чем у людей со школьным уровнем образования CI(1.10, 1.47)")

```
## Этнос и страховка

```{r}
insurance_data %>% 
  count(ethnicity)

insurance_data %>% 
  select(c("ethnicity", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> ethnicity_table

ethnicity_table <- cbind("Этнос" = rownames(ethnicity_table), ethnicity_table)
rownames(ethnicity_table) <- NULL


ft_ethnicity <- flextable(ethnicity_table)
ft_ethnicity <- autofit(ft_ethnicity)
ft_ethnicity <- theme_vanilla(ft_ethnicity)
ft_ethnicity <- add_header_lines(ft_ethnicity, values = "Этнос и наличие страховки")
ft_ethnicity <- align(ft_ethnicity, i = 1, part = "header", align = "center")
ft_ethnicity
```

```{r}
insurance_data %>% 
  select(c("ethnicity", "insurance")) %>% 
  table %>% 
  chisq.test() -> ethnicity

cat("Проверка гипотезы о независимости этноса и наличия страховки\n")
ethnicity$method
cat("P-value:")
ethnicity$p.value
cat("Отклоняем нулевую гипотезу о независимости этноса и наличия страховки")
```
Сила ассоциации

```{r}
insurance_data %>% 
  select(c("ethnicity", "insurance")) %>% 
  table -> ethnicity_3x2

riskratio(ethnicity_3x2[c("afam", "cauc"), ], rev = "columns") -> rr_af_c
rr_af_c$measure
cat("RR показывает, что у европеоидных людей в 1.06 раза чаще встречается страховка, чем у афроамериканцев CI(1.03, 1.10)")

```

```{r}
riskratio(ethnicity_3x2[c("afam", "other"), ], rev = "columns") -> rr_af_o
rr_af_o$measure
cat("RR показывает, что у прочих людей в 0.99 раза реже встречается страховка, чем у афроамериканцев CI(0.926, 1.05)
    CI наркывает 1!!!")
```
```{r}
riskratio(ethnicity_3x2[c("cauc", "other"), ], rev = "columns") -> rr_c_o
rr_c_o$measure
cat("RR показывает, что у прочих людей в 0.93 раза реже встречается страховка, чем у европеоидных CI(0.877, 0.988)")
```
## Возраст и страховка
Возраст - количественная переменная. Для удобства можно разбить ее на 2 категории - до 40 лет и после. 
```{r}
insurance_data %>% 
  mutate(age_binary = ifelse(age <= 40, "Младше 40", "Старше 40")) -> insurance_data_age
```

```{r}
insurance_data_age %>% 
  select(c("age_binary", "insurance")) %>% 
  table %>% 
  as.data.frame.matrix -> age_table

age_table <- cbind("Возраст" = rownames(age_table), age_table)
rownames(age_table) <- NULL


ft_age <- flextable(age_table)
ft_age <- autofit(ft_age)
ft_age <- theme_vanilla(ft_age)
ft_age <- add_header_lines(ft_age, values = "Возраст и наличие страховки")
ft_age <- align(ft_age, i = 1, part = "header", align = "center")
ft_age

```

```{r}
insurance_data_age %>% 
  select(c("age_binary", "insurance")) %>% 
  table %>% 
  chisq.test() -> age

cat("Проверка гипотезы о независимости возраста и наличия страховки\n")
age$method
cat("P-value:")
age$p.value
cat("Отклоняем нулевую гипотезу о независимости возраста и наличия страховки")

```

```{r}
insurance_data_age %>% 
  select(c("age_binary", "insurance")) %>% 
  table %>% 
  riskratio(., rev = "columns") -> rr_age

rr_age$measure
cat("RR показывает, что у людей старше 40 лет в 1.12 раз чаще встречается страховка CI(1.106324 - 1.152467)")
```

##Число членов семьи и страховка

```{r}
insurance_data %>% 
  


```




